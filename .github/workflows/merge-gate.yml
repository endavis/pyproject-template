name: Merge Gate

on:
  pull_request:
    branches: [main]
    types: [opened, labeled, unlabeled, synchronize, reopened]

jobs:
  require-label:
    permissions:
      contents: read
      checks: read
      actions: read
    runs-on: ubuntu-latest
    steps:
      - name: Check for ready-to-merge label
        id: check-label
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'ready-to-merge') }}" != "true" ]]; then
            echo "::error::PR requires 'ready-to-merge' label before merging"
            echo "Add the label when the PR is reviewed and ready to merge."
            exit 1
          fi
          echo "✓ ready-to-merge label present"

      - name: Wait for CI to complete
        uses: actions/github-script@v8
        with:
          script: |
            const sha = context.payload.pull_request.head.sha;
            const maxAttempts = 30;  // 5 minutes max wait
            const delaySeconds = 10;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Checking CI status (attempt ${attempt}/${maxAttempts})...`);

              // Get check runs for this commit
              const checks = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: sha
              });

              // Find CI workflow runs (the "test" job from ci.yml)
              const ciRuns = checks.data.check_runs.filter(run =>
                run.name.includes('test') && run.app.slug === 'github-actions'
              );

              if (ciRuns.length === 0) {
                console.log('No CI runs found yet, waiting...');
                await new Promise(r => setTimeout(r, delaySeconds * 1000));
                continue;
              }

              // Check if any are still in progress
              const inProgress = ciRuns.some(run =>
                run.status === 'queued' || run.status === 'in_progress'
              );

              if (inProgress) {
                console.log('CI still running, waiting...');
                await new Promise(r => setTimeout(r, delaySeconds * 1000));
                continue;
              }

              // All complete - check if all passed
              const allPassed = ciRuns.every(run => run.conclusion === 'success');

              if (allPassed) {
                console.log(`✓ All ${ciRuns.length} CI jobs passed`);
                return;
              } else {
                const failed = ciRuns.filter(r => r.conclusion !== 'success');
                core.setFailed(
                  `CI failed: ${failed.map(r => r.name).join(', ')}\n` +
                  'Fix CI issues before merging.'
                );
                return;
              }
            }

            core.setFailed('Timed out waiting for CI to complete');
