# Python Project Template – AI Agent Instructions

## Overview
Modern Python template using `uv` (package management), `doit` (task automation), `ruff` (formatting/linting), and `mypy` (type checking). Follows strict code quality standards with comprehensive CI/CD.

**AI Agent Compatibility:** Codex CLI, Gemini CLI, Claude Code (via `.claude/CLAUDE.md`)

## Key Architecture

**Package Structure:**
- `src/` layout for proper imports
- `_version.py` auto-generated by hatch-vcs from git tags during build
- **CRITICAL:** Version source of truth is Git tags, not `pyproject.toml`
- Never manually edit version in `pyproject.toml` (it's a placeholder)

**Temporary Files:**
- All caches → `tmp/` directory (configured in `.envrc`)
- Keeps project root clean

**Environment:**
- `direnv` auto-loads environment variables from `.envrc`
- Personal overrides in `.envrc.local` (git-ignored)

## Development Workflow (MANDATORY)

**Rule:** All changes must originate from a GitHub Issue.

### Workflow Steps
1. **Issue:** Ensure GitHub Issue exists for the task
   - Use YAML issue forms (bug_report.yml, feature_request.yml, refactor.yml)
   - Required fields ensure complete information

2. **Branch:** Create branch linked to issue
   - Format: `<type>/<number>-<description>`
   - Types: `issue`, `feat`, `fix`, `docs`, `test`, `refactor`, `chore`, `ci`, `perf`, `hotfix`
   - Examples: `feat/42-user-auth`, `fix/123-handle-nulls`
   - Link: Use `gh issue develop <issue-number> --checkout` or add issue number in branch name

3. **Commit:** Use Conventional Commits format
   - Format: `<type>: <subject>`
   - Enforced by pre-commit hooks and CI
   - Use `doit commit` for interactive commit creation

4. **Pull Request:** Submit PR from branch to `main`
   - Reference issue: "Closes #42" or "Part of #42"
   - PR title must follow conventional commit format
   - PR title becomes merge commit message

5. **Merge:** Format must include PR and issue numbers
   - `<type>: <subject> (merges PR #XX, closes #YY)` - when PR completes issue
   - `<type>: <subject> (merges PR #XX, part of #YY)` - when PR is part of multi-PR issue

**Examples - Correct Merge Format:**
```
feat: add user authentication (merges PR #18, closes #42)
fix: handle None values (merges PR #23, closes #19)
```

**Examples - Incorrect:**
```
❌ Merge pull request #18 from user/branch
❌ feat: Add Feature (capitalized)
❌ added feature (missing type)
❌ feat: add feature (missing PR reference)
```

### Why Issue-Driven Development?
- **Traceability:** Every change linked to documented need
- **Context:** Issues capture the "why"
- **History:** Searchable record of decisions

## Commit Guidelines

### Format
```
<type>: <subject>

[optional body]

[optional footer]
```

**Types:** `feat`, `fix`, `refactor`, `docs`, `test`, `chore`, `ci`, `perf`

**Rules:**
- Subject: lowercase, concise (no period at end)
- Imperative mood: "add feature" not "added feature"
- One commit per logical change
- Clear, descriptive messages

### Breaking Changes
**What qualifies:**
- Changes to public function/method signatures
- Removal of public APIs
- CLI command/option changes
- Configuration format changes
- Default behavior changes
- Exception type changes

**How to handle:**
1. Add `BREAKING CHANGE:` in commit footer with migration info
2. Document in PR description with before/after examples
3. Update CHANGELOG.md
4. Requires major version bump (handled by commitizen)

## Code Style & Conventions

### Python Style
- **Python 3.12+** - Use modern syntax
- **Type hints required** for all public functions/methods
  - Modern syntax: `list[str]`, `dict[str, Any]`, `X | None`
  - Avoid legacy: `typing.List`, `typing.Optional`
- **Line length:** Max 100 characters
- **Docstrings:** Google-style, required for public APIs
- **Naming:**
  - `snake_case`: functions, variables, modules
  - `PascalCase`: classes
  - `UPPER_CASE`: constants

### Import Organization
Three groups separated by blank lines:
```python
# Standard library
import os
from pathlib import Path

# Third-party
import click

# Local
from package_name import __version__
```

### Docstring Format (Google-style)
```python
def process_data(data: list[dict[str, Any]], validate: bool = True) -> dict[str, Any]:
    """Process input data and return results.

    Args:
        data: List of data dictionaries to process
        validate: Whether to validate data before processing

    Returns:
        Dictionary containing processed results

    Raises:
        ValueError: If data validation fails
    """
```

## Coding Standards

### General Principles
- **Read before editing** - Always read files before modifying
- **Backward compatibility** - Don't break public APIs without major version bump
- **Early returns** - Prefer over deep nesting
- **Explicit over implicit** - Make intentions clear
- **Single responsibility** - Functions/classes do one thing well

### Error Handling
- Raise specific exceptions with clear messages
- Never catch `KeyboardInterrupt` or `SystemExit`
- Log errors with context before raising
- Use custom exception classes for domain errors

### Security
- Never log secrets or sensitive data
- Use `subprocess` with list args, avoid `shell=True`
- Validate user-provided paths (prevent path traversal)
- Use `yaml.safe_load()`, never `yaml.load()`

### Anti-Patterns to Avoid
- ❌ Mutable default arguments: `def foo(items=[]):`
- ❌ String concatenation for paths - use `Path` objects
- ❌ Ignoring type hints - mypy enforces them
- ❌ God classes - keep focused and modular
- ❌ Silent failures - always log and raise
- ❌ Blocking I/O in loops - batch operations

## Testing Expectations

### Requirements
- Maintain ≥80% test coverage (enforced in CI)
- Tests in `tests/` directory
- Follow pytest conventions: `test_*.py`, `test_*` functions
- Run `doit check` before committing

### Best Practices
- Test all public APIs
- Use fixtures for common setup
- Parametrize tests for multiple input cases
- Mock external dependencies
- Test edge cases and error conditions

### Commands
```bash
doit test      # Run all tests
doit coverage  # Run with coverage report
doit check     # Run all checks (format, lint, type-check, test)
```

## Common Development Tasks

**Quality checks:**
```bash
doit format        # Format with ruff
doit lint          # Lint with ruff
doit type_check    # Type check with mypy
doit check         # Run all checks + tests
```

**Pre-commit:**
```bash
doit pre_commit_install  # Install hooks
doit pre_commit_run      # Run on all files
```

**Release:**
```bash
doit release       # Production release (stable v*)
doit release_dev   # Dev release (prerelease v* → TestPyPI)
```

**Other:**
```bash
doit list          # Show all available tasks
doit cleanup       # Remove all build artifacts and caches
```

See `doit list` for complete task list.

## CI/CD Workflows

### Continuous Integration (ci.yml)
**Trigger:** Push to main/develop or PRs

**Checks:**
- Test on Python 3.12, 3.13
- Format check (`ruff format --check`)
- Linting (`ruff check`)
- Type checking (`mypy`)
- Tests with coverage (≥80%)
- Upload coverage to Codecov

**All checks must pass before merge.**

### Releases
**Pre-release tags** (e.g., `v1.0.0-alpha.1`) → TestPyPI only
**Stable tags** (e.g., `v1.0.0`) → TestPyPI + PyPI

Use `doit release` or `doit release_dev` (recommended).

## Pull Request Requirements

### PR Title
- Must follow conventional commit format: `<type>: <subject>`
- Becomes the merge commit message
- Examples: ✅ `feat: add validators`, ❌ `Add validators`

### PR Description (enforced by CI)
- Minimum 50 characters
- Reference related issue ("Closes #123" or "Part of #123")
- Describe what changed and why
- Include testing information

### Automated Checks
✅ PR title format (conventional commits)
✅ Issue link present
✅ Description length ≥50 chars
✅ Breaking changes documented
✅ All tests pass
✅ Coverage ≥80%
✅ Linting passes
✅ Type checking passes
✅ Format check passes

### Documentation Requirements
Update relevant docs with code changes:
- **Code docs:** Docstrings for modified functions/classes
- **User docs:** README.md, usage guides for new features
- **API docs:** docs/api.md for API changes
- **Developer docs:** AGENTS.md, CONTRIBUTING.md for workflow changes
- **CHANGELOG.md:** Entry for notable changes

**Skip docs for:** Internal refactoring, test-only changes, build/CI changes (unless affecting workflow)

### Code Review Checklist
**Before submitting:**
- [ ] Issue created and linked
- [ ] Branch name follows convention
- [ ] `doit check` passes locally
- [ ] Tests added/updated (≥80% coverage)
- [ ] Docs updated
- [ ] Breaking changes documented (if applicable)

## AI Agent Guidelines

### When to Ask User
- Multiple valid implementation approaches
- Architectural decisions
- Breaking changes that impact users
- Ambiguous or incomplete requirements
- Significant trade-offs between approaches

### When to Proceed Autonomously
- Clear codebase conventions exist
- Obvious bugs with single solution
- Documentation improvements
- Refactoring that maintains behavior
- Adding missing test coverage
- Following established patterns

### Best Practices
- **Before committing:** Ensure pre-commit hooks installed
- **Read first:** Always read files before editing
- **Follow patterns:** Match existing code style
- **Test changes:** Run `doit check`
- **Commit format:** Use conventional commits
- **Commit granularity:** Multiple logical commits per PR, not one monolithic commit
- **Update docs:** Keep documentation synchronized
- **No merging:** Don't merge without user consent

## Project Documentation

**Core docs:** README.md, CHANGELOG.md, AGENTS.md, AI_SETUP.md, LICENSE
**Contributing:** .github/CONTRIBUTING.md, CODE_OF_CONDUCT.md, SECURITY.md
**Tasks:** See `doit list` for all available development tasks
**User docs:** docs/ directory (index.md, installation.md, usage.md, api.md, extensions.md, migration.md)
**Examples:** examples/ directory (basic_usage.py, advanced_usage.py, cli_usage.py)

## Quick Reference

**Setup:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
uv venv && source .venv/bin/activate
uv pip install -e ".[dev]"
doit pre_commit_install
```

**Development cycle:**
1. Ensure issue exists
2. Create branch: `git checkout -b <type>/<issue#>-<desc>`
3. Make changes, run `doit check`
4. Commit: `doit commit`
5. Push and create PR
6. Wait for CI checks and review

**Important reminders:**
- Never edit version in `pyproject.toml` (git tags are source of truth)
- All caches in `tmp/` directory
- Pre-commit hooks enforce commit format and branch naming
- PR title becomes merge commit message
- Always link PRs to issues

---
For detailed setup instructions, troubleshooting, and tool documentation, see README.md, .github/CONTRIBUTING.md, and docs/ directory.
