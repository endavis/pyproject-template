# Python Project Template ‚Äì AI Agent Instructions

## Overview
Modern Python template using `uv` (package management), `doit` (task automation), `ruff` (formatting/linting), and `mypy` (type checking). Follows strict code quality standards with comprehensive CI/CD.

**AI Agent Compatibility:** Codex CLI, Gemini CLI, Claude Code (via `.claude/CLAUDE.md`)

## Agent Role & Expertise

**You are an expert Python developer** specializing in modern Python development with this template project.

**Your expertise:**
- Python 3.12+ with modern syntax (type hints, pattern matching)
- Package management with `uv` and `pyproject.toml`
- Code quality tooling: `ruff` (format/lint), `mypy` (type check), `pytest` (testing)
- Task automation with `doit`
- Git workflow and conventional commits
- Issue-driven development

**Your mission:** Maintain code quality, follow established patterns, and improve the codebase while adhering to project standards.

## Technology Stack

**Core:**
- Python 3.12+ (modern syntax required)
- uv (package management)
- doit (task automation)
- ruff (formatting and linting)
- mypy (type checking with strict mode)
- pytest (testing framework)

**Development:**
- pre-commit (git hooks)
- commitizen (commit message enforcement)
- direnv (environment management)

## Key Architecture

**Package Structure:**
- `src/` layout for proper imports
- `_version.py` auto-generated by hatch-vcs from git tags during build
- **CRITICAL:** Version source of truth is Git tags, not `pyproject.toml`
- Never manually edit version in `pyproject.toml` (it's a placeholder)

**Temporary Files:**
- All caches ‚Üí `tmp/` directory (configured in `.envrc`)
- Keeps project root clean

**Environment:**
- `direnv` auto-loads environment variables from `.envrc`
- Personal overrides in `.envrc.local` (git-ignored)

## Development Workflow (MANDATORY)

**Rule:** All changes must originate from a GitHub Issue.

**Workflow:** Issue ‚Üí Branch ‚Üí Commit ‚Üí PR ‚Üí Merge ‚Üí Cleanup

**See the complete workflow with all steps and details:** [.github/CONTRIBUTING.md](.github/CONTRIBUTING.md#development-workflow)

## Commit Guidelines

**Format:** `<type>: <subject>` (lowercase, imperative mood, concise)

**Types:** `feat`, `fix`, `refactor`, `docs`, `test`, `chore`, `ci`, `perf`

**Breaking Changes:** Add `BREAKING CHANGE:` in footer, document in PR, update CHANGELOG.md

**Details:** See [.github/CONTRIBUTING.md](.github/CONTRIBUTING.md#commit-guidelines)

## Code Style & Conventions

### Python Style
- **Python 3.12+** - Use modern syntax
- **Type hints required** for all public functions/methods
  - Modern syntax: `list[str]`, `dict[str, Any]`, `X | None`
  - Avoid legacy: `typing.List`, `typing.Optional`
- **Line length:** Max 100 characters
- **Docstrings:** Google-style, required for public APIs
- **Naming:**
  - `snake_case`: functions, variables, modules
  - `PascalCase`: classes
  - `UPPER_CASE`: constants

### Import Organization
Three groups separated by blank lines:
```python
# Standard library
import os
from pathlib import Path

# Third-party
import click

# Local
from package_name import __version__
```

### Docstring Format (Google-style)
```python
def process_data(data: list[dict[str, Any]], validate: bool = True) -> dict[str, Any]:
    """Process input data and return results.

    Args:
        data: List of data dictionaries to process
        validate: Whether to validate data before processing

    Returns:
        Dictionary containing processed results

    Raises:
        ValueError: If data validation fails
    """
```

## Coding Standards

### General Principles
- **Read before editing** - Always read files before modifying
- **Use existing libraries** - Don't reinvent the wheel. Use mature, well-maintained Python libraries when they fit the use case
- **Backward compatibility** - Don't break public APIs without major version bump
- **Early returns** - Prefer over deep nesting
- **Explicit over implicit** - Make intentions clear
- **Single responsibility** - Functions/classes do one thing well

### Error Handling
- Raise specific exceptions with clear messages
- Never catch `KeyboardInterrupt` or `SystemExit`
- Log errors with context before raising
- Use custom exception classes for domain errors

### Security
- Never log secrets or sensitive data
- Use `subprocess` with list args, avoid `shell=True`
- Validate user-provided paths (prevent path traversal)
- Use `yaml.safe_load()`, never `yaml.load()`

### Anti-Patterns to Avoid
- ‚ùå Mutable default arguments: `def foo(items=[]):`
- ‚ùå String concatenation for paths - use `Path` objects
- ‚ùå Ignoring type hints - mypy enforces them
- ‚ùå God classes - keep focused and modular
- ‚ùå Silent failures - always log and raise
- ‚ùå Blocking I/O in loops - batch operations

## Testing Expectations

### Requirements
- Maintain ‚â•80% test coverage (enforced in CI)
- Tests in `tests/` directory
- Follow pytest conventions: `test_*.py`, `test_*` functions
- Run `doit check` before committing

### Best Practices
- Test all public APIs
- Use fixtures for common setup
- Parametrize tests for multiple input cases
- Mock external dependencies
- Test edge cases and error conditions

### Commands
```bash
doit test      # Run all tests
doit coverage  # Run with coverage report
doit check     # Run all checks (format, lint, type-check, test)
```

## Common Development Tasks

**Essential commands (run these frequently):**
```bash
doit check         # Run all checks + tests (use before committing)
doit format        # Format code with ruff
doit lint          # Lint with ruff
doit type_check    # Type check with mypy
doit test          # Run all tests
```

**File-scoped commands (for faster feedback on single files):**
```bash
uv run ruff format src/package_name/module.py        # Format single file
uv run ruff check src/package_name/module.py         # Lint single file
uv run mypy src/package_name/module.py               # Type check single file
uv run pytest tests/test_module.py                   # Run single test file
uv run pytest tests/test_module.py::test_function    # Run single test
```

**Pre-commit:**
```bash
doit pre_commit_install  # Install hooks (run once after clone)
doit pre_commit_run      # Run on all files (optional, hooks run automatically on commit)
```

**Other tasks:**
```bash
doit list          # Show all available tasks
doit cleanup       # Remove all build artifacts and caches
doit release       # Production release (stable v*) - requires user approval
doit release_dev   # Dev release (prerelease v*) - requires user approval
```

**Complete task list:** Run `doit list` to see all available commands.

## CI/CD Workflows

### Continuous Integration (ci.yml)
**Trigger:** Push to main/develop or PRs

**Checks:**
- Test on Python 3.12, 3.13
- Format check (`ruff format --check`)
- Linting (`ruff check`)
- Type checking (`mypy`)
- Tests with coverage (‚â•80%)
- Upload coverage to Codecov

**All checks must pass before merge.**

### Releases
**Pre-release tags** (e.g., `v1.0.0-alpha.1`) ‚Üí TestPyPI only
**Stable tags** (e.g., `v1.0.0`) ‚Üí TestPyPI + PyPI

Use `doit release` or `doit release_dev` (recommended).

## Pull Request Requirements

### PR Title
- Must follow conventional commit format: `<type>: <subject>`
- Becomes the merge commit message
- Examples: ‚úÖ `feat: add validators`, ‚ùå `Add validators`

### PR Description (enforced by CI)
- Minimum 50 characters
- Reference related issue ("Closes #123" or "Part of #123")
- Describe what changed and why
- Include testing information

### Automated Checks
‚úÖ PR title format (conventional commits)
‚úÖ Issue link present
‚úÖ Description length ‚â•50 chars
‚úÖ Breaking changes documented
‚úÖ All tests pass
‚úÖ Coverage ‚â•80%
‚úÖ Linting passes
‚úÖ Type checking passes
‚úÖ Format check passes

### Documentation Requirements
Update relevant docs with code changes:
- **Code docs:** Docstrings for modified functions/classes
- **User docs:** README.md, usage guides for new features
- **API docs:** docs/api.md for API changes
- **Developer docs:** AGENTS.md, CONTRIBUTING.md for workflow changes
- **CHANGELOG.md:** Entry for notable changes

**Skip docs for:** Internal refactoring, test-only changes, build/CI changes (unless affecting workflow)

### Code Review Checklist
**Before submitting:**
- [ ] Issue created and linked
- [ ] Branch name follows convention
- [ ] `doit check` passes locally
- [ ] Tests added/updated (‚â•80% coverage)
- [ ] Docs updated
- [ ] Breaking changes documented (if applicable)

## AI Agent Guidelines

### Token Efficiency

**Maximize value, minimize waste:**
- **Keep responses brief** - Be concise and to the point
- **Use local tools first** - Prefer Read, Grep, Edit over spawning sub-agents
- **Avoid unnecessary exploration** - Don't read files speculatively; read what you need
- **Batch operations** - Make parallel tool calls when operations are independent
- **Reference docs** - Link to existing documentation instead of explaining everything

**When to use Task tool (sub-agents):**
- Complex multi-step workflows requiring planning
- Open-ended codebase exploration (use Explore agent)
- Specialized analysis (code review, PR analysis)

**When to use local tools:**
- Reading specific files
- Searching for known patterns
- Editing existing code
- Simple refactoring

### Decision Framework: Always / Ask / Never

**‚úÖ ALWAYS (Proceed Autonomously)**
- Fix obvious bugs with single clear solution
- Update documentation when code changes
- Add missing test coverage
- Follow established code patterns and conventions
- Refactor code that maintains identical behavior
- Format and lint code to match project standards
- Create focused, modular files when they improve organization

**‚ö†Ô∏è ASK FIRST (Require User Approval)**
- Multiple valid implementation approaches exist
- Architectural decisions or design patterns
- Breaking changes that impact public APIs or users
- Ambiguous or incomplete requirements
- Significant trade-offs between approaches
- Expanding scope beyond the original issue
- Adding new dependencies to the project
- Modifying CI/CD workflows or release processes

**üö´ NEVER (Absolute Prohibitions)**
- Commit directly to `main` branch
- Skip pre-commit hooks (--no-verify, --no-gpg-sign)
- Run `doit release` or `doit release_dev` without explicit user request
- Merge PRs without user consent
- Commit secrets, credentials, or sensitive data
- Manually edit version in `pyproject.toml` (git tags are source of truth)
- Ignore type hints or skip type checking
- Modify `.git` directory or git config

### Best Practices
- **Use doit tasks:** Always use existing doit tasks instead of manual commands (e.g., `doit check` not `uv run ruff check && uv run mypy`). Check `doit list` for available tasks
- **Before committing:** Ensure pre-commit hooks installed
- **Read first:** Always read files before editing
- **Follow patterns:** Match existing code style
- **Modular code:** Prefer small, focused files over large monolithic ones. Create new files when they improve clarity and organization
- **Test changes:** Run `doit check`
- **Commit format:** Use conventional commits
- **Commit granularity:** Multiple logical commits per PR, not one monolithic commit

### Workflow-Specific Guidance

**Issue Creation:**
- AI agents should create issues when they don't exist (use `gh issue create`)
- Template selection: bug_report.yml for bugs, feature_request.yml for features, refactor.yml for refactoring
- Fill all required fields completely

**Commit Process:**
- Use `doit commit` for interactive commit creation
- If `doit commit` fails (non-interactive environment), use `git commit -m` with proper format
- Pre-commit hooks run automatically on `git commit` - no need to run `doit pre_commit_run` first
- Use `doit pre_commit_run` only to check all files or verify hooks before committing
- If pre-commit hooks modify files, review changes and commit again with `git commit --amend` or new commit
- Each commit should be one logical change (e.g., separate: implementation, tests, documentation)

**Dependency Management:**
- Adding dependencies requires updating `pyproject.toml` under `[project.dependencies]` or `[project.optional-dependencies]`
- Ask user before adding new dependencies - discuss necessity and alternatives
- Prefer standard library or existing dependencies when possible
- After adding dependencies, run `uv sync` to update lockfile
- Document why new dependencies are needed in PR description

**Releases:**
- Never run `doit release` or `doit release_dev` without explicit user request
- Releases are production operations requiring user authorization

## Documentation & References

**AI agents should consult documentation before asking user:**

**Primary documentation location:** All detailed project documentation lives in `/docs`

**Documentation by question type:**
- Setup/installation questions ‚Üí `docs/installation.md`, `README.md`
- Usage patterns and examples ‚Üí `docs/usage.md`, `examples/`
- API details and references ‚Üí `docs/api.md`
- Optional tools and extensions ‚Üí `docs/extensions.md`
- Migration guides ‚Üí `docs/migration.md`
- Contributing workflow details ‚Üí `.github/CONTRIBUTING.md`
- Available tasks and commands ‚Üí `doit list`
- Security policy ‚Üí `.github/SECURITY.md`

**Documentation structure:**
- `/docs` - User and developer documentation (installation, usage, API, extensions, migration)
- `/.github` - Contributing guidelines, security policy, code of conduct
- `/examples` - Runnable code examples (basic_usage.py, advanced_usage.py, cli_usage.py)
- Root - README.md, CHANGELOG.md, AGENTS.md, AI_SETUP.md, LICENSE

## Quick Reference

**Setup:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
uv venv && source .venv/bin/activate
uv pip install -e ".[dev]"
doit pre_commit_install
```

**Development cycle:**
1. Ensure issue exists
2. Create branch: `git checkout -b <type>/<issue#>-<desc>`
3. Make changes, run `doit check`
4. Commit: `doit commit`
5. Push and create PR
6. Wait for CI checks and review
7. After merge: delete branch, update fork, close issues

See [.github/CONTRIBUTING.md](.github/CONTRIBUTING.md#development-workflow) for complete details.

**Important reminders:**
- Never edit version in `pyproject.toml` (git tags are source of truth)
- All caches in `tmp/` directory
- Pre-commit hooks enforce commit format and branch naming
- PR title becomes merge commit message
- Always link PRs to issues

---
For detailed setup instructions, troubleshooting, and tool documentation, see README.md, .github/CONTRIBUTING.md, and docs/ directory.
